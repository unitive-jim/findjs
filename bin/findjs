#!/usr/bin/env node
'use strict';

const _ = require('lodash');
const program = require('commander');
const debug = require('debug');
const descendents = require('../lib/descendents');
const P = require('bluebird');

const dlog = debug('findjs:main');

function collect(val, memo) {
  memo.push(val);
  return memo;
}

program
  .option('-f, --file-match [pattern]', 'Include files that match pattern', collect, [])
  .option('-d, --dir-match [pattern]', 'Exclude directories matching pattern', collect, [])
  .option('-g, --grep [pattern]', 'Instead of listing files, grep each file for pattern')
  .parse(process.argv);

const defaultFileIncludes = [ /\.js$/ ];
const defaultDirExcludes = [ /node_modules\//, /.git\// ];

const includes = program.fileMatch.length ? _.map(program.fileMatch, (p) => new RegExp(p)) : defaultFileIncludes;
const excludes = program.dirMatch.length ? _.map(program.dirMatch, (p) => new RegExp(p)) : defaultDirExcludes;
const roots = program.args.length ? program.args : [ './' ];

function getAllFiles() {
  dlog(`getAllFiles(${roots})`);
  return P.map(roots, (root) => {
    return descendents.all(root, includes, excludes);
  })
  .then((results) => _.flatten(results));
}

function doGrep(f) {
  dlog(`doGrep(${f})`);
  // TODO implementation
}

getAllFiles()
  .then((files) => {
    if (!program.grep) {
      _.each(files, (f) => console.log(f));
    } else {
      return P.each(files, (f) => doGrep(f));
    }
  });
